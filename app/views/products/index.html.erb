<h1>Listing products</h1>
<p>
  <%= Time.new  %> 現在の最新情報
</p>

<%
today = Date.today
%>
<p>
  今日は <%=today.month %> 月<%=today.day %>日です。
</p>

<%
 require 'nokogiri'
 require 'open-uri'
 require 'nkf'

re = Regexp.new("[^>]+/(HA|KA)([0-9]+)\\.pdf")
doc = Nokogiri::HTML

# webページの場合 open-uri利用
doc = Nokogiri::HTML(open('http://chiba-monorail.co.jp/index.php/info-timetable/urban-monochan/'))

#File.open("table.htm","r:UTF-8") { |io|  doc = Nokogiri::HTML(io)}

## モノちゃん号の取得
%>
<p>モノちゃん号取得</p>
<%
doc.xpath("//table[@class='mono-time']//td/a").each do |i|
  
  /(1?[0-9]?\/)?([0-9]+)/ =~ NKF.nkf('-m0Z1 -w', i.text)
%><%= "day: " + $2 %><%
  re =~ i.attribute("href").value %>
<%="tyep: " + $1 %>
<%="tableNo: "  + $2%> 
<br/>
<%
end
%> <br/><br/>
<p>URBAN取得</p>
<%
# URBAN
# とりあえず目的の数値が取れそうな所までは追い込んだ
doc.xpath("//table[@class='urban-time']//tr//a").each do |node|
  #    puts node.attribute("href").value

  trainNo =  NKF.nkf('-m0Z1 -w', node.text)
  re =~  node.attribute("href").value
  type = NKF.nkf('-m0Z1 -w', $1)
  tableNo = NKF.nkf('-m0Z1 -w', $2)
    
  count = node.xpath("count(ancestor::td/preceding-sibling::td)") 
  day =  node.xpath("ancestor::tr[position()=1]/preceding-sibling::tr[position()=1]/td[position()=" + ((count-1) / 4 +1).to_i.to_s+ "]/text()") 
 
  /(1?[0-9]\/)?([0-9]+)[^\/]+/ =~ NKF.nkf('-m0Z1 -w',day.to_s)
  %><%= "day: " + $2 %><%
  
  %><%= "traknNo: " + trainNo %><%
  %><%= "type: " +type %><%
  %><%= "tableNo: " + tableNo  %><%
  
  %><br/><%
end
%>


<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Price</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @products.each do |product| %>
      <tr>
        <td><%= product.name %></td>
        <td><%= product.price %></td>
        <td><%= link_to 'Show', product %></td>
        <td><%= link_to 'Edit', edit_product_path(product) %></td>
        <td><%= link_to 'Destroy', product, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Product', new_product_path %>
